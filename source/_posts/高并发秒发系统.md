---
title: 高并发秒发系统
date: 2019-04-25 08:27:05
tags:
    - 并发
    - 秒杀
categories:
---
在每年的双十一、618等促销活动中，淘宝、京东等电商平台都会推出众多的秒杀活动，作为一个开发人员都会有一个疑问“这些秒杀活动是如何设计及支持如此大量的瞬时请求的”？
## 秒杀活动的特点
* 秒杀业务简单，卖家查询，买家下订单减库存
* 秒杀时网站访问流量激增，出现峰值
* 访问请求数量远大于实际需求量

## 秒杀系统设计方案
### 概述
 一个秒杀系统从前到后，依次有：
 `前端浏览器秒杀页面 ---> 中间代理服务 ---> 后端服务层 ---> 数据库层`
根据上面这个流程，一般优化设计思路：`将请求拦截在系统上游，降低下游压力`。在一个并发量大，实际需求小的系统中，应当尽量在前端拦截无效流量，降低下游服务器和数据库的压力，不然很可能造成数据库读写锁冲突，甚至导致死锁，最终请求超时。 
设计思路与优化点：
* 限流：屏蔽掉无用的流量，允许少部分流量流向后端。
* 削峰：瞬时大流量峰值容易压垮系统，解决这个问题是重中之重。常用的消峰方法有异步处理、缓存和消息中间件等技术。
* 异步处理：秒杀系统是一个高并发系统，采用异步处理模式可以极大地提高系统并发量，其实异步处理就是削峰的一种实现方式。
* 内存缓存：秒杀系统最大的瓶颈一般都是数据库读写，由于数据库读写属于磁盘IO，性能很低，如果能够把部分数据或业务逻辑转移到内存缓存，效率会有极大地提升。
* 可拓展：当然如果我们想支持更多用户，更大的并发，最好就将系统设计成弹性可拓展的，如果流量来了，拓展机器就好了。像淘宝、京东等双十一活动时会增加大量机器应对交易高峰。
* 消息队列：消息队列可以削峰，将拦截大量并发请求，这也是一个异步处理过程，后台业务根据自己的处理能力，从消息队列中主动的拉取请求消息进行业务处理。
* 充分利用缓存：利用缓存可极大提高系统读写速度。 

### 详细方案
#### 前端方案
* 静态资源缓存：将活动页面上的所有可以静态的元素全部静态化，尽量减少动态元素；通过CDN缓存静态资源，来抗峰值。 
* 禁止重复提交：用户提交之后按钮置灰，禁止重复提交 
* 用户限流：在某一时间段内只允许用户提交一次请求，比如可以采取IP限流

#### 中间代理层
可利用负载均衡（例如反响代理Nginx等）使用多个服务器并发处理请求，减小服务器压力。

#### 后端方案
##### 控制层(网关层)
限制同一UserID访问频率：尽量拦截浏览器请求，但针对某些恶意攻击或其它插件，在服务端控制层需要针对同一个访问uid，限制访问频率。

##### 服务层
当用户量非常大的时候，拦截流量后的请求访问量还是非常大，此时仍需进一步优化。
* 业务分离:将秒杀业务系统和其他业务分离，单独放在高配服务器上，可以集中资源对访问请求抗压。
* 采用消息队列缓存请求：将大流量请求写到消息队列缓存，利用服务器根据自己的处理能力主动到消息缓存队列中抓取任务处理请求，数据库层订阅消息减库存，减库存成功的请求返回秒杀成功，失败的返回秒杀结束。
* 利用缓存应对读请求：对于读多写少业务，大部分请求是查询请求，所以可以读写分离，利用缓存分担数据库压力。
* 利用缓存应对写请求：缓存也是可以应对写请求的，可把数据库中的库存数据转移到Redis缓存中，所有减库存操作都在Redis中进行，然后再通过后台进程把Redis中的用户秒杀请求同步到数据库中。

##### 数据库层
 数据库层是最脆弱的一层，一般在应用设计时在上游就需要把请求拦截掉，数据库层只承担“能力范围内”的访问请求。所以，上面通过在服务层引入队列和缓存，让最底层的数据库高枕无忧。如果不使用缓存来作为中间缓冲而是直接访问数据库的话，可以对数据库进行优化，减少数据库压力。 对于秒杀系统，直接访问数据库的话，存在一个【事务竞争优化】问题，可使用存储过程（或者触发器）等技术绑定操作，整个事务在MySQL端完成，把整个热点执行放在一个过程当中一次性完成，可以屏蔽掉网络延迟时间，减少行级锁持有时间，提高事务并发访问速度。


